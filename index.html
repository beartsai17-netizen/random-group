<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>隨機分組系統</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      background-color: #f0f4f8;
    }
    .container {
      width: 90%;
      max-width: 400px;
      background-color: #fff;
      padding: 20px;
      margin-top: 40px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover { background-color: #0056b3; }
    .result {
      margin-top: 20px;
      font-size: 1.2em;
      text-align: center;
    }
    .host-view { display: none; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background-color: #f2f2f2; }
    .error { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <!-- 參與者頁 -->
  <div class="container" id="participant-view">
    <h1>隨機分組系統</h1>
    <div id="form-section">
      <label for="name-input">請輸入姓名：</label>
      <input type="text" id="name-input" placeholder="輸入您的姓名">
      <button id="submit-btn">加入並分組</button>
      <div id="error-msg" class="error"></div>
    </div>
    <div id="result-section" class="result" style="display:none;"></div>
  </div>

  <!-- 主持人頁 -->
  <div class="container host-view" id="host-view">
    <h1>主持人：名單與分組</h1>
    <button id="refresh-btn">刷新名單</button>
    <button id="clear-btn" style="margin-left:10px;background-color:#dc3545;">清空名單</button>
    <table id="list-table">
      <thead><tr><th>#</th><th>姓名</th><th>組別</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 主要腳本（Modular Firebase） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction,
      collection, getDocs, deleteDoc, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js";

    // ========= Firebase init =========
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ========= 固定場次 ID =========
    const SID = "default";
    const sessionRef = doc(db, "sessions", SID);
    const groupsCol  = collection(db, "sessions", SID, "groups");
    const assignsCol = collection(db, "sessions", SID, "assignments");

    // ========= DOM 參照 =========
    const participantView = document.getElementById("participant-view");
    const hostView        = document.getElementById("host-view");
    const nameInput  = document.getElementById("name-input");
    const submitBtn  = document.getElementById("submit-btn");
    const errorMsg   = document.getElementById("error-msg");
    const resultSec  = document.getElementById("result-section");
    const refreshBtn = document.getElementById("refresh-btn");
    const clearBtn   = document.getElementById("clear-btn");
    const listTable  = document.getElementById("list-table");

    // ========= 預設設定 =========
    const DEFAULTS = {
      groupCount: 3,
      groupSize: 6,
      noGroupEnabled: true, // 是否允許抽到「沒分組(0)」
      noGroupProb: 0.10     // 當仍有名額時抽到 0 的機率（0~1）
    };

    // ========= 小工具 =========
    function showError(msg){ if (errorMsg) errorMsg.textContent = msg || ""; }
    function showResult(name, group) {
      document.getElementById("form-section").style.display = "none";
      resultSec.style.display = "block";
      resultSec.textContent = group > 0 ? `${name}，你是第 ${group} 組！` : `${name}，你沒分到組。`;
    }

    // 確保 session/config 與 groups/1..N 存在（若不存在就用預設建立）
    async function ensureSessionAndGroups() {
      const snap = await getDoc(sessionRef);
      let cfg = { ...DEFAULTS, isLocked: false };
      if (!snap.exists()) {
        await setDoc(sessionRef, { ...cfg, createdAt: serverTimestamp() });
      } else {
        cfg = { ...DEFAULTS, ...(snap.data()||{}) };
      }
      // 建立群組 1..N
      for (let i = 1; i <= cfg.groupCount; i++) {
        const gRef = doc(groupsCol, String(i));
        const gSnap = await getDoc(gRef);
        if (!gSnap.exists()) await setDoc(gRef, { count: 0 });
      }
      return cfg;
    }

    // ========= 參與者：加入（採交易避免搶位；以剩餘名額加權抽籤）=========
    async function joinGroup(name) {
      const key = name.trim().toLowerCase();
      const assignRef = doc(assignsCol, key);

      const groupNo = await runTransaction(db, async (tx) => {
        const sSnap = await tx.get(sessionRef);
        if (!sSnap.exists()) throw new Error("尚未設定組數/每組人數");

        const s = { ...DEFAULTS, ...(sSnap.data()||{}) };
        const { groupCount, groupSize, noGroupEnabled, noGroupProb, isLocked } = s;
        if (isLocked) throw new Error("目前已鎖定，停止加入");
        if (!groupCount || !groupSize) throw new Error("主辦尚未完成設定");

        // 已加入過 → 回傳舊組別
        const aSnap = await tx.get(assignRef);
        if (aSnap.exists()) return aSnap.data().group;

        // 讀各組 count
        const groups = [];
        for (let i = 1; i <= groupCount; i++) {
          const gRef = doc(groupsCol, String(i));
          const gSnap = await tx.get(gRef);
          const count = gSnap.exists() ? (gSnap.data().count || 0) : 0;
          groups.push({ id: i, ref: gRef, count });
        }

        // 依「剩餘名額」加權抽籤
        const withCap = groups
          .map(g => ({ ...g, cap: Math.max(0, groupSize - g.count) }))
          .filter(g => g.cap > 0);

        let assigned = 0;
        if (withCap.length === 0) {
          // 全滿 → 0 組（或照你的規則）
          assigned = 0;
        } else {
          // 加權抽：cap 越大，被抽到機率越高
          const totalCap = withCap.reduce((s, g) => s + g.cap, 0);
          let r = Math.random() * totalCap;
          let picked = withCap[0];
          for (const g of withCap) {
            r -= g.cap;
            if (r <= 0) { picked = g; break; }
          }
          assigned = picked.id;

          // 若開啟「沒分組」，再以機率把 0 納入抽籤池一次（平衡效果）
          if (noGroupEnabled && Math.random() < Math.max(0, Math.min(1, noGroupProb))) {
            assigned = 0;
          }

          // 寫回該組 count +1（當 assigned>0）
          if (assigned > 0) {
            tx.update(picked.ref, { count: picked.count + 1 });
          }
        }

        // 寫入分配結果
        tx.set(assignRef, { name, group: assigned, at: serverTimestamp() });
        return assigned;
      });

      return groupNo;
    }

    // ========= 主持人：渲染名單 =========
    async function renderList() {
      const { cfg } = await ensureSessionAndGroups();
      const aSnaps = await getDocs(assignsCol);

      // 繪表
      const tbody = listTable.querySelector("tbody");
      tbody.innerHTML = "";
      let i = 0;
      aSnaps.forEach(d => {
        const a = d.data() || {};
        const tr = document.createElement("tr");
        const tdIndex = document.createElement("td"); tdIndex.textContent = (++i).toString();
        const tdName  = document.createElement("td"); tdName.textContent  = a.name || "";
        const tdGroup = document.createElement("td"); tdGroup.textContent = (a.group > 0) ? a.group : "沒分組";
        tr.appendChild(tdIndex); tr.appendChild(tdName); tr.appendChild(tdGroup);
        tbody.appendChild(tr);
      });

      // 更新主持人設定 UI（如果第一次載入會動態生成）
      initOrSyncConfigInputs(cfg);
    }

    // ========= 主持人：清空 =========
    async function clearAll() {
      // 刪 assignments/*
      const aSnaps = await getDocs(assignsCol);
      for (const d of aSnaps.docs) await deleteDoc(d.ref);
      // groups/* 歸零
      const gSnaps = await getDocs(groupsCol);
      for (const d of gSnaps.docs) await updateDoc(d.ref, { count: 0 });
      // session 狀態重置
      await updateDoc(sessionRef, { isLocked: false, updatedAt: serverTimestamp() });
    }

    // ========= 主持人：設定 UI =========
    let configInputsInitialized = false;
    function initOrSyncConfigInputs(cfg) {
      const container = document.getElementById("host-view");
      if (!configInputsInitialized) {
        const div = document.createElement("div");
        div.style.marginTop = "15px";
        div.innerHTML = `
          <div style="margin:10px 0;">
            <label>組數：
              <input type="number" id="group-count-input" min="1" style="width:80px; margin-right:10px;">
            </label>
            <label>每組人數：
              <input type="number" id="group-size-input" min="1" style="width:100px; margin-right:10px;">
            </label>
          </div>
          <div style="margin:10px 0;">
            <label style="margin-right:10px;">
              啟用「沒分到組」
              <input type="checkbox" id="nog-enabled-input" style="margin-left:6px;">
            </label>
            <label>
              「沒分到組」機率（0~1）：
              <input type="number" id="nog-prob-input" min="0" max="1" step="0.01" style="width:100px;">
            </label>
          </div>
          <button id="update-config-btn" style="background-color:#28a745; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">更新設定</button>
        `;
        container.appendChild(div);

        document.getElementById("update-config-btn").addEventListener("click", async () => {
          const newCfg = {
            groupCount: parseInt(document.getElementById("group-count-input").value) || DEFAULTS.groupCount,
            groupSize:  parseInt(document.getElementById("group-size-input").value)  || DEFAULTS.groupSize,
            noGroupEnabled: !!document.getElementById("nog-enabled-input").checked,
            noGroupProb: Math.max(0, Math.min(1, parseFloat(document.getElementById("nog-prob-input").value)))
          };
          // 寫回 Firestore
          await setDoc(sessionRef, { ...newCfg, updatedAt: serverTimestamp() }, { merge: true });
          // 確保 groups/1..N 都存在
          for (let i = 1; i <= newCfg.groupCount; i++) {
            const gRef = doc(groupsCol, String(i));
            const gSnap = await getDoc(gRef);
            if (!gSnap.exists()) await setDoc(gRef, { count: 0 });
          }
          alert("設定已更新！");
          renderList();
        });

        configInputsInitialized = true;
      }

      // 同步值
      document.getElementById("group-count-input").value = cfg.groupCount;
      document.getElementById("group-size-input").value  = cfg.groupSize;
      document.getElementById("nog-enabled-input").checked = !!cfg.noGroupEnabled;
      document.getElementById("nog-prob-input").value      = cfg.noGroupProb;
    }

    // ========= 畫面切換（沿用 ?admin=1）=========
    const isAdmin = new URLSearchParams(window.location.search).get("admin") === "1";
    if (isAdmin) {
      participantView.style.display = "none";
      hostView.style.display = "block";

      // 初次載入 + 即時更新
      await ensureSessionAndGroups();
      await renderList();
      refreshBtn.addEventListener("click", renderList);

      // 兩段式清空（避免某些環境 confirm 被擋）
      let clearArmed = false;
      const clearDefaultText = "清空名單";
      clearBtn.addEventListener("click", async () => {
        if (!clearArmed) {
          clearArmed = true;
          const old = clearBtn.textContent;
          clearBtn.textContent = "再按一次確認清空";
          clearBtn.style.opacity = "0.9";
          // 8 秒內未再次按下就恢復
          setTimeout(() => {
            if (clearArmed) {
              clearArmed = false;
              clearBtn.textContent = old;
              clearBtn.style.opacity = "1";
            }
          }, 8000);
          return;
        }
        // 第二次點擊 → 真的清空
        clearArmed = false;
        clearBtn.textContent = clearDefaultText;
        clearBtn.style.opacity = "1";
        await clearAll();
        await renderList();
        alert("已清空");
      });

      onSnapshot(assignsCol, renderList);
      onSnapshot(sessionRef, renderList);

    } else {
      hostView.style.display = "none";
      participantView.style.display = "block";

      await ensureSessionAndGroups();

      // 若本機曾報名，試著顯示舊結果；若主持人已清空，則移除 localStorage
      const storedName  = localStorage.getItem("userName");
      const storedGroup = localStorage.getItem("userGroup");
      if (storedName && storedGroup !== null) {
        try {
          const a = await getDoc(doc(assignsCol, storedName.trim().toLowerCase()));
          if (a.exists()) {
            showResult(storedName, a.data().group);
          } else {
            localStorage.removeItem("userName");
            localStorage.removeItem("userGroup");
          }
        } catch {}
      }

      submitBtn.addEventListener("click", async () => {
        const name = (nameInput.value || "").trim();
        if (!name) { showError("姓名不能為空"); return; }
        showError("");
        try {
          const group = await joinGroup(name);
          localStorage.setItem("userName", name);
          localStorage.setItem("userGroup", String(group));
          showResult(name, group);
        } catch (e) { showError(`加入失敗：${e.message || e}`); }
      });
    }
  </script>
</body>
</html>
